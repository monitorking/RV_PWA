<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clima en ruta</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
    #map { height: 50vh; }
    .content { flex: 1; display: flex; }
    .left, .right { flex: 1; padding: 1rem; overflow-y: auto; }
    .poi-item { margin-bottom: 0.5rem; cursor: pointer; }
  </style>
</head>
<body><div id="map"></div>
<div class="content">
  <div class="left">
    <div id="clima">Cargando clima‚Ä¶</div>
  </div>
  <div class="right">
    <select id="categoria-poi">
      <option value="fuel">‚õΩ Gasolineras</option>
      <option value="camp">üèïÔ∏è √Åreas autocaravanas</option>
    </select>
    <div id="poi-list"></div>
  </div>
</div><script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><script>
let map = L.map('map').setView([40.4168, -3.7038], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker = L.marker([0,0], {icon: L.icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',iconSize:[32,32]})}).addTo(map);
let poiMarkers = [];
let lastPos = null;

function actualizarClima(lat, lon) {
  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
    .then(r=>r.json())
    .then(d=>{
      document.getElementById('clima').textContent = `üå°Ô∏è ${d.current_weather.temperature} ¬∞C ¬∑ üå¨Ô∏è ${d.current_weather.windspeed} km/h`;
    });
}

function buscarPOI(lat, lon) {
  const cat = document.getElementById('categoria-poi').value;
  localStorage.setItem('categoria-poi', cat);

  poiMarkers.forEach(m => map.removeLayer(m));
  poiMarkers = [];
  document.getElementById('poi-list').innerHTML = 'Buscando‚Ä¶';

  let query = '';
  if (cat === 'fuel') query = 'gasolinera';
  if (cat === 'camp') query = 'camping OR autocaravana';

  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&lat=${lat}&lon=${lon}`;

  fetch(url, {headers:{'Accept-Language':'es'}})
    .then(r=>r.json())
    .then(data => {
      const list = document.getElementById('poi-list');
      list.innerHTML = '';

      data.slice(0,5).forEach((p,i) => {
        const d = distancia(lat, lon, p.lat, p.lon).toFixed(2);
        const div = document.createElement('div');
        div.className = 'poi-item';
        div.textContent = `${i+1}. ${p.display_name.split(',')[0]} (${d} km)`;
        div.onclick = ()=>map.setView([p.lat,p.lon],15);
        list.appendChild(div);

        const color = cat === 'fuel' ? 'blue' : 'orange';
        const icon = L.divIcon({html:`<b style="color:${color}">${i+1}</b>`,className:''});
        const m = L.marker([p.lat,p.lon],{icon}).addTo(map).bindPopup(p.display_name);
        poiMarkers.push(m);
      });
    });
}

function distancia(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function actualizar(){
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude, speed} = pos.coords;
    userMarker.setLatLng([latitude,longitude]);
    map.setView([latitude,longitude],12);
    actualizarClima(latitude,longitude);

    if (!lastPos || distancia(lastPos.lat,lastPos.lon,latitude,longitude) > 0.5) {
      buscarPOI(latitude,longitude);
      lastPos = {lat:latitude, lon:longitude};
    }
  });
}

document.getElementById('categoria-poi').addEventListener('change', ()=>{
  if (lastPos) buscarPOI(lastPos.lat,lastPos.lon);
});

const saved = localStorage.getItem('categoria-poi');
if (saved) document.getElementById('categoria-poi').value = saved;

actualizar();
setInterval(actualizar,60000);
</script></body>
</html>
