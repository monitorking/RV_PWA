<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clima en ruta</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; }
    #map { height: 50vh; }
    .content { display: flex; flex: 1; }
    .left, .right { flex: 1; padding: 1rem; overflow-y: auto; }
    .poi-item { margin-bottom: 0.5rem; cursor: pointer; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="content">
    <div class="left">
      <div id="clima">
        <div id="fecha-hoy"></div>
        <div id="clima-detalles"></div>
        <div id="temp-max-dia"></div>
        <div>Viento: <span id="velocidad-viento"></span> km/h</div>
        <div>Veh√≠culo: <span id="velocidad-vehiculo"></span> km/h</div>
        <div id="pronostico"></div>
      </div>
    </div>
    <div class="right">
      <select id="categoria-poi">
        <option value="gasolineras">‚õΩ Gasolineras</option>
        <option value="areas">üèïÔ∏è √Åreas autocaravanas</option>
      </select>
      <div id="poi-list"></div>
    </div>
  </div><script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script>
const diasSemana = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];let map = L.map('map'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const redIcon = new L.Icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [32,32]}); let userMarker = L.marker([0,0], {icon:redIcon}).addTo(map); let poiMarkers = []; let refreshTimer = null;

function mostrarFecha() { const h = new Date(); document.getElementById('fecha-hoy').textContent = ${diasSemana[h.getDay()]}, ${h.getDate()} de ${meses[h.getMonth()]} de ${h.getFullYear()}; }

function refrescoPorVelocidad(kmh) { if (kmh < 10) return 1560000; if (kmh < 50) return 660000; return 3*60000; }

function actualizarTemporizador(kmh) { const intervalo = refrescoPorVelocidad(kmh); if (refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(actualizarUbicacion, intervalo); }

function mostrarPOIs(lat, lon) { const categoria = localStorage.getItem('categoria-poi') || 'gasolineras'; document.getElementById('categoria-poi').value = categoria;

poiMarkers.forEach(m => map.removeLayer(m)); poiMarkers = []; document.getElementById('poi-list').innerHTML = '';

const filtros = categoria === 'gasolineras' ? ['amenity=fuel'] : ['tourism=camp_site','tourism=caravan_site','amenity=sanitary_dump_station'];

const parts = filtros.map(f => { const [k,v] = f.split('='); return node(around:5000,${lat},${lon})["${k}"="${v}"]; });

const query = [out:json];(${parts.join(';')});out body;;

fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query)) .then(r=>r.json()) .then(data => { const ordenados = data.elements.map(e => ({...e, d:dist(lat,lon,e.lat,e.lon)})) .sort((a,b)=>a.d-b.d).slice(0,5);

ordenados.forEach((e,i)=>{
    const num=i+1;
    const name=e.tags.name||'Sin nombre';
    const item=document.createElement('div');
    item.className='poi-item';
    item.textContent=`${num}. ${name} - ${e.d.toFixed(1)} km`;
    item.onclick=()=>map.setView([e.lat,e.lon],15);
    document.getElementById('poi-list').appendChild(item);

    const color = categoria==='gasolineras'?'blue':'orange';
    const icon=L.divIcon({html:`<b style="color:${color}">${num}</b>`,className:''});
    poiMarkers.push(L.marker([e.lat,e.lon],{icon}).addTo(map).bindPopup(name));
  });
});

}

function dist(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)Math.PI/180; const dLon=(lon2-lon1)Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1Math.PI/180)Math.cos(lat2Math.PI/180)Math.sin(dLon/2)**2; return R2Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

let primeraCarga = true;

function actualizarUbicacion(){ navigator.geolocation.getCurrentPosition(pos=>{ const {latitude:lat,longitude:lon,speed}=pos.coords; const kmh=((speed||0)*3.6); userMarker.setLatLng([lat,lon]); map.setView([lat,lon], map.getZoom()||12); document.getElementById('velocidad-vehiculo').textContent=kmh.toFixed(1); mostrarFecha(); mostrarPOIs(lat,lon); if (primeraCarga) { // Forzar refresco inmediato de POI en la primera carga if (refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(actualizarUbicacion, refrescoPorVelocidad(kmh)); primeraCarga = false; } else { actualizarTemporizador(kmh); } }); }

categoria-poi.onchange=e=>{ localStorage.setItem('categoria-poi',e.target.value); actualizarUbicacion(); };

actualizarUbicacion(); </script>

</body>
</html>
