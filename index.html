<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clima en ruta</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    #map { height: 50vh; }
    .content { display: flex; flex: 1; }
    .left, .right { flex: 1; padding: 1rem; overflow-y: auto; }
    .poi-item { margin-bottom: 0.5rem; cursor: pointer; }
    #poi-status { font-size: 0.9rem; color: #666; margin-top: 0.5rem; }
  </style>
</head>
<body><div id="map"></div><div class="content">
  <div class="left">
    <div id="fecha-hoy"></div>
    <div>Veh√≠culo: <span id="velocidad-vehiculo">--</span> km/h</div>
  </div>
  <div class="right">
    <select id="categoria-poi">
      <option value="gasolineras">‚õΩ Gasolineras</option>
      <option value="areas">üèïÔ∏è √Åreas autocaravanas</option>
    </select>
    <div id="poi-list"></div>
    <div id="poi-status"></div>
  </div>
</div><script src="https://unpkg.com/leaflet/dist/leaflet.js"></script><script>
const diasSemana = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];

let map = L.map('map').setView([40, -3], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

const userIcon = L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [32,32] });
let userMarker = L.marker([40, -3], { icon: userIcon }).addTo(map);
let poiMarkers = [];
let refreshTimer = null;
let primeraCarga = true;
let ultimaPos = null;

function mostrarFecha() {
  const h = new Date();
  document.getElementById('fecha-hoy').textContent = `${diasSemana[h.getDay()]}, ${h.getDate()} de ${meses[h.getMonth()]} de ${h.getFullYear()}`;
}

function intervaloPorVelocidad(kmh) {
  if (kmh < 10) return 15 * 60000;
  if (kmh < 50) return 6 * 60000;
  return 3 * 60000;
}

function iniciarTemporizador(kmh) {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(actualizarUbicacion, intervaloPorVelocidad(kmh));
}

function distanciaKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function cargarPOI(lat, lon, forzar = false) {
  const categoria = localStorage.getItem('categoria-poi') || 'gasolineras';
  document.getElementById('categoria-poi').value = categoria;

  const cacheKey = `poi_${categoria}`;
  const cache = JSON.parse(localStorage.getItem(cacheKey) || 'null');

  if (!forzar && cache && distanciaKm(lat, lon, cache.lat, cache.lon) < 0.5) {
    pintarPOI(cache.data, categoria, lat, lon);
    document.getElementById('poi-status').textContent = 'POI cargados desde cach√©';
    return;
  }

  document.getElementById('poi-status').textContent = 'Actualizando puntos de inter√©s‚Ä¶';

  poiMarkers.forEach(m => map.removeLayer(m));
  poiMarkers = [];
  document.getElementById('poi-list').innerHTML = '';

  const filtros = categoria === 'gasolineras'
    ? ['amenity=fuel']
    : ['tourism=camp_site','tourism=caravan_site','amenity=sanitary_dump_station'];

  const query = `[out:json];(${filtros.map(f => {
    const [k,v] = f.split('=');
    return `node(around:5000,${lat},${lon})["${k}"="${v}"]`;
  }).join(';')});out body;`;

  fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query))
    .then(r => r.json())
    .then(data => {
      localStorage.setItem(cacheKey, JSON.stringify({ lat, lon, data }));
      pintarPOI(data, categoria, lat, lon);
      document.getElementById('poi-status').textContent = 'POI actualizados';
    });
}

function pintarPOI(data, categoria, lat, lon) {
  poiMarkers.forEach(m => map.removeLayer(m));
  poiMarkers = [];
  document.getElementById('poi-list').innerHTML = '';

  const ordenados = data.elements
    .map(e => ({ ...e, d: distanciaKm(lat, lon, e.lat, e.lon) }))
    .sort((a,b) => a.d - b.d)
    .slice(0,5);

  ordenados.forEach((e,i) => {
    const num = i + 1;
    const nombre = e.tags.name || 'Sin nombre';
    const item = document.createElement('div');
    item.className = 'poi-item';
    item.textContent = `${num}. ${nombre} - ${e.d.toFixed(1)} km`;
    item.onclick = () => map.setView([e.lat, e.lon], 15);
    document.getElementById('poi-list').appendChild(item);

    const color = categoria === 'gasolineras' ? 'blue' : 'orange';
    const icon = L.divIcon({ html: `<b style="color:${color}">${num}</b>`, className: '' });
    poiMarkers.push(L.marker([e.lat, e.lon], { icon }).addTo(map).bindPopup(nombre));
  });
}

function actualizarUbicacion() {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude: lat, longitude: lon, speed } = pos.coords;
    const kmh = (speed || 0) * 3.6;

    userMarker.setLatLng([lat, lon]);
    if (!ultimaPos) map.setView([lat, lon], 12);

    document.getElementById('velocidad-vehiculo').textContent = kmh.toFixed(1);
    mostrarFecha();

    cargarPOI(lat, lon, primeraCarga);

    if (primeraCarga) {
      iniciarTemporizador(kmh);
      primeraCarga = false;
    }

    ultimaPos = [lat, lon];
  });
}

document.getElementById('categoria-poi').addEventListener('change', e => {
  localStorage.setItem('categoria-poi', e.target.value);
  if (ultimaPos) cargarPOI(ultimaPos[0], ultimaPos[1], true);
});

actualizarUbicacion();
</script></body>
</html>
